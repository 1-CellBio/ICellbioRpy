---
title: "Introduction to ICellbioRpy"
author: "ICellbioRpy Development Team"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to ICellbioRpy}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = FALSE
)
```

# ICellbioRpy

The ICellbioRpy package provides comprehensive functions to work with single-cell and spatial transcriptomics data. It enables seamless conversion between different single-cell data formats including:

- Reading 1Cellbio zip files into R objects
- Reading Stereo-seq GEF files with cell boundary information
- Converting to SingleCellExperiment and Seurat objects
- Converting to h5ad format for Python/Scanpy analysis
- Bidirectional conversion between h5ad and R objects
- GMT gene set preprocessing with gene ID mapping

## Installation

You can install the development version of ICellbioRpy from GitHub:

```{r}
# Install devtools if you haven't already
install.packages("devtools")

# Install ICellbioRpy from GitHub
devtools::install_github("1-Cellbio/ICellbioRpy")
```

## Quick Start

### Loading the package

```{r}
library(ICellbioRpy)
```

### Python Environment Configuration

The package provides smart Python environment configuration for h5ad operations:

```{r}
# Automatic configuration (recommended)
configure_python_env()

# Smart interactive configuration - lists available environments
smart_python_config(verbose = TRUE, interactive = TRUE)

# Manual configuration with specific Python path
configure_python_env(python_path = "/path/to/python")

# Manual configuration with conda environment
configure_python_env(conda_env = "scanpy")
```

## Core Functions

### 1. Reading 1Cellbio Results

The `read1Cellbio()` function reads zip files containing 1Cellbio results:

```{r}
# Read 1Cellbio results from a zip file
data <- read1Cellbio("path/to/1cellbio_results.zip")

# Check the class of the object
class(data)
#> [1] "1CellbioData"
```

### 2. Converting to h5ad Format

The `iCellbio2H5ad()` function converts 1Cellbio zip files directly to h5ad format:

```{r}
# Convert 1Cellbio zip to h5ad format
iCellbio2H5ad("1cellbio_results.zip", "output.h5ad")

# With parameter controls
iCellbio2H5ad("1cellbio_results.zip", "output.h5ad",
            overwrite = FALSE,           # do not overwrite existing files
            name_conflict = "make_unique") # auto-rename on conflicts
)
```

### 3. Converting to SingleCellExperiment

```{r}
# Convert to SingleCellExperiment (new .1CB functions with auto-detection)
sce <- as.SingleCellExperiment.1CB(data)

# Or manually specify column names
sce <- as.SingleCellExperiment(data,
                              rownames = "id",
                              colnames = "cell_id")

# Check the class and dimensions
class(sce)
#> [1] "SingleCellExperiment"

# Access assays
assayNames(sce)
#> [1] "counts" "logcounts"

# Access dimensionality reductions
reducedDimNames(sce)
#> [1] "PCA"  "TSNE" "UMAP"
```

### 4. Converting to Seurat Object

```{r}
# Convert to Seurat object (new .1CB functions with auto-detection)
seurat <- as.Seurat.1CB(data)

# Or manually specify column names
seurat <- as.Seurat(data,
                   rownames = "id",
                   colnames = "cell_id")

# Check the class
class(seurat)
#> [1] "Seurat"

# Access dimensionality reductions
names(seurat@reductions)
#> [1] "pca"  "tsne" "umap"
```

## Stereo-seq Spatial Transcriptomics

ICellbioRpy supports reading Stereo-seq GEF files with complete cell boundary information.

### Reading GEF Files

```{r}
# Read GEF file with cell boundaries
stereo_data <- read_gef("sample1.gef",
                        bin_type = "cell_bins",
                        include_cellborder = TRUE)

# View summary
summary(stereo_data)
```

### Converting to R Objects

```{r}
# Convert to Seurat
seurat_stereo <- as.Seurat(stereo_data)

# Spatial coordinates in reductions
seurat_stereo@reductions$spatial

# Cell boundaries in @misc
seurat_stereo@misc$cell_borders

# Convert to SingleCellExperiment
sce_stereo <- as.SingleCellExperiment(stereo_data)
```

### Spatial Visualization

```{r}
# Plot with cell borders
plot_cells_with_borders(stereo_data,
                        color_by = "cluster",
                        show_borders = TRUE,
                        border_color = "gray")
```

### Direct GEF to H5AD Conversion

```{r}
# Direct conversion (memory efficient)
gef_to_h5ad("sample1.gef", "output.h5ad",
            bin_type = "cell_bins",
            include_cellborder = TRUE,
            include_spatial = TRUE)
```

## Bidirectional h5ad Conversion

### From h5ad to R Objects

```{r}
# Convert h5ad to SingleCellExperiment
sce <- h5ad_to_sce("data.h5ad",
                  use_x_as = "auto",            # auto-detect X layer type
                  name_conflict = "make_unique") # naming conflict handling

# Convert h5ad to Seurat
seurat <- h5ad_to_seurat("data.h5ad")
```

### From R Objects to h5ad

```{r}
# Convert Seurat object to h5ad
seurat_to_h5ad(seurat_object, "output.h5ad",
               overwrite = FALSE,
               name_conflict = "make_unique")
```

## GMT Gene Set Preprocessing

ICellbioRpy provides GMT file preprocessing with gene ID mapping support.

### Basic Usage

```{r}
# Preprocess GMT file
preprocess_gmt_custom(
  gmt_file = "pathways.gmt",
  species = "9606",          # 9606 = human
  output_dir = "gesel_output"
)
```

### Performance Optimization with Pre-built Tables

```{r}
# Step 1: Pre-build lookup tables for all species
prebuild_gene_lookup_tables(
  data_dir = "~/gene_mapping_data",
  output_file = "gene_lookup_tables.rdata"
)

# Step 2: Load into global environment
load("gene_lookup_tables.rdata")

# Step 3: Process GMT files (auto-uses pre-built tables)
preprocess_gmt_custom("pathways.gmt", species = "9606")

# Batch process multiple GMT files
for (gmt in list.files(pattern = "\\.gmt$")) {
  preprocess_gmt_custom(gmt, species = "9606")
}
```

### Supported Species

- 9606: Human (Homo sapiens)
- 10090: Mouse (Mus musculus)
- 10116: Rat (Rattus norvegicus)
- 7227: Fruit fly (Drosophila melanogaster)
- 6239: Nematode (Caenorhabditis elegans)
- 7955: Zebrafish (Danio rerio)
- 9598: Chimpanzee (Pan troglodytes)

## Data Access and Manipulation

### Working with SingleCellExperiment

```{r}
# Access count data
counts_matrix <- counts(sce)

# Access log-normalized data
logcounts_matrix <- logcounts(sce)

# Access cell metadata
cell_metadata <- colData(sce)

# Access gene metadata
gene_metadata <- rowData(sce)

# Access dimensionality reductions
pca_coords <- reducedDim(sce, "PCA")
umap_coords <- reducedDim(sce, "UMAP")
```

### Working with Seurat Objects

```{r}
# Access count data
counts_matrix <- GetAssayData(seurat, layer = "counts")

# Access normalized data
norm_data <- GetAssayData(seurat, layer = "data")

# Access cell metadata
cell_metadata <- seurat[[]]

# Access dimensionality reductions
pca_coords <- Embeddings(seurat, reduction = "pca")
umap_coords <- Embeddings(seurat, reduction = "umap")
```

## Integration with Analysis Workflows

### Using with Bioconductor

```{r}
library(scater)
library(scran)

# Quality control
sce <- addPerCellQC(sce)
sce <- addPerFeatureQC(sce)

# Visualization
plotPCA(sce, colour_by = "level1class")
plotUMAP(sce, colour_by = "level1class")
```

### Using with Seurat

```{r}
library(Seurat)

# Standard Seurat workflow
seurat <- NormalizeData(seurat)
seurat <- FindVariableFeatures(seurat)
seurat <- ScaleData(seurat)

# Visualization
DimPlot(seurat, reduction = "umap", group.by = "level1class")
FeaturePlot(seurat, features = c("gene1", "gene2"))
```

### Using with Python/Scanpy

After converting to h5ad format, you can use the data in Python:

```python
import scanpy as sc
import pandas as pd

# Read the h5ad file
adata = sc.read_h5ad("output.h5ad")

# Basic information
print(adata)

# Visualization
sc.pl.umap(adata, color='level1class')
sc.pl.violin(adata, keys=['gene1', 'gene2'], groupby='level1class')

# Further analysis
sc.tl.rank_genes_groups(adata, 'level1class')
sc.pl.rank_genes_groups(adata)
```

## Data Structure Details

### Gene Expression Matrices

The package preserves the sparse nature of count data for memory efficiency:

```{r}
# Count matrix is sparse
class(counts(sce))
#> [1] "dgCMatrix"

# Check sparsity
Matrix::nnzero(counts(sce)) / length(counts(sce))
#> [1] 0.05  # 5% non-zero values
```

### Metadata Preservation

All metadata from the original 1Cellbio analysis is preserved:

```{r}
# Cell-level metadata
colnames(colData(sce))
#> [1] "tissue" "group" "total.mRNA.mol" "well" "sex" "level1class" ...

# Gene-level metadata
colnames(rowData(sce))
#> [1] "gene_id" "gene_symbol" ...
```

### Dimensionality Reductions

All computed dimensionality reductions are available:

```{r}
# Check available reductions
reducedDimNames(sce)
#> [1] "PCA"  "TSNE" "UMAP"

# Dimensions
dim(reducedDim(sce, "PCA"))   # [1] n_cells 20
dim(reducedDim(sce, "TSNE"))  # [1] n_cells 2
dim(reducedDim(sce, "UMAP"))  # [1] n_cells 2
```

## Troubleshooting

### Python Environment Issues

If you encounter Python/anndata related errors:

```{r}
# Check if anndata is available
check_anndata_available()

# Reconfigure Python environment
configure_python_env(verbose = TRUE)

# Smart configuration with environment selection
smart_python_config(verbose = TRUE, interactive = TRUE)

# Install anndata in current environment
# (Run in terminal: pip install anndata)
```

### Column Detection Issues

```{r}
# Show available column options
show_column_options(data)

# Convert with auto-detection
sce <- as.SingleCellExperiment.1CB(data)

# Or manually specify columns
sce <- as.SingleCellExperiment.1CB(data,
                                    rownames = "gene_name",
                                    colnames = "cell_id")
```

### Memory Considerations

For large datasets, consider:

```{r}
# Check object size
object.size(sce)

# Use sparse matrices when possible
# (automatically handled by the package)

# For very large datasets, consider working with h5ad files directly
# and loading subsets as needed
```

## Advanced Features

### Batch Processing

```{r}
# Process multiple files
zip_files <- list.files(pattern = "*.zip")
for (zip_file in zip_files) {
  output_name <- gsub(".zip", ".h5ad", zip_file)
  iCellbio2H5ad(zip_file, output_name)
}
```

### 10X MTX Integration

```{r}
# Prepare sample information CSV
sample_info <- data.frame(
  Sample_id = c("sample1", "sample2"),
  mtx_fns = c("path/to/sample1/matrix.mtx.gz",
             "path/to/sample2/matrix.mtx.gz"),
  features_fns = c("path/to/sample1/features.tsv.gz",
                  "path/to/sample2/features.tsv.gz"),
  barcodes_fns = c("path/to/sample1/barcodes.tsv.gz",
                   "path/to/sample2/barcodes.tsv.gz")
)
write.csv(sample_info, "samples.csv", row.names = FALSE)

# Integrate multiple samples
read_10x_mtx_to_h5ad("samples.csv", "integrated.h5ad",
                     min_counts_per_cell = 200)
```

## Session Information

```{r}
sessionInfo()
```
