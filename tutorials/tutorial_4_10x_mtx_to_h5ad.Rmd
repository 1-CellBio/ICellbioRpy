---
title: "æ•™ç¨‹4: è¯»å–10X MTXæ ¼å¼æ•°æ®å¹¶è½¬æ¢ä¸ºH5AD"
author: "ICellbioRpyæ•™ç¨‹"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: show
    theme: cosmo
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, eval = FALSE)
```

# ğŸ¯ æ•™ç¨‹ç›®æ ‡

æœ¬æ•™ç¨‹å°†è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨`ICellbioRpy`åŒ…çš„`read_10x_mtx_to_h5ad()`å‡½æ•°ï¼Œä»å¤šä¸ª10X Cell Rangerè¾“å‡ºçš„MTXæ ¼å¼æ–‡ä»¶ä¸­è¯»å–æ•°æ®ï¼Œè¿›è¡ŒåŸºæœ¬çš„è´¨é‡æ§åˆ¶ï¼Œå¹¶æ•´åˆä¸ºå•ä¸€çš„H5ADæ–‡ä»¶ï¼Œæ–¹ä¾¿åç»­åœ¨Pythonç¯å¢ƒä¸­è¿›è¡Œåˆ†æã€‚

# ğŸ“‹ å‰ææ¡ä»¶

## å¿…éœ€çš„è½¯ä»¶ç¯å¢ƒ

1. **R (â‰¥ 4.0.0)**
2. **Python (â‰¥ 3.7) + anndataåŒ…**
3. **å¿…éœ€çš„RåŒ…**: data.table, Matrix, ICellbioRpy

```{r check-requirements, eval=TRUE}
# æ£€æŸ¥å¿…éœ€çš„RåŒ…
required_packages <- c("data.table", "Matrix", "reticulate")
missing_packages <- required_packages[!sapply(required_packages, requireNamespace, quietly = TRUE)]

if (length(missing_packages) > 0) {
  cat("éœ€è¦å®‰è£…ä»¥ä¸‹RåŒ…:\n")
  cat("install.packages(c(", paste0("'", missing_packages, "'", collapse = ", "), "))\n")
} else {
  cat("âœ“ æ‰€æœ‰å¿…éœ€çš„RåŒ…å·²å®‰è£…\n")
}
```

## 10Xæ•°æ®æ ¼å¼è¯´æ˜

10X Cell Rangerè¾“å‡ºçš„æ ‡å‡†æ ¼å¼åŒ…å«ä¸‰ä¸ªæ–‡ä»¶ï¼š

1. **matrix.mtx** (æˆ– matrix.mtx.gz): ç¨€ç–çŸ©é˜µæ ¼å¼çš„åŸºå› è¡¨è¾¾æ•°æ®
2. **features.tsv** (æˆ– features.tsv.gz, genes.tsv): åŸºå› ä¿¡æ¯ï¼ŒåŒ…å«åŸºå› IDå’ŒåŸºå› å
3. **barcodes.tsv** (æˆ– barcodes.tsv.gz): ç»†èƒbarcodeåˆ—è¡¨

```
filtered_feature_bc_matrix/
â”œâ”€â”€ matrix.mtx.gz
â”œâ”€â”€ features.tsv.gz  (æˆ– genes.tsv.gz)
â””â”€â”€ barcodes.tsv.gz
```

# ğŸš€ å¼€å§‹æ•™ç¨‹

## ç¬¬1æ­¥: ç¯å¢ƒè®¾ç½®

```{r setup-environment}
# åŠ è½½å¿…éœ€çš„åŒ…
library(ICellbioRpy)
library(data.table)
library(Matrix)

# æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
cat("=== åŒ…ç‰ˆæœ¬ä¿¡æ¯ ===\n")
cat("ICellbioRpy:", as.character(packageVersion("ICellbioRpy")), "\n")
cat("data.table:", as.character(packageVersion("data.table")), "\n")
cat("Matrix:", as.character(packageVersion("Matrix")), "\n")
```

## ç¬¬2æ­¥: é…ç½®Pythonç¯å¢ƒï¼ˆå¿…éœ€æ­¥éª¤ï¼‰

å³ä½¿å¤„ç†MTXæ ¼å¼æ•°æ®ï¼Œæœ€ç»ˆè¾“å‡ºH5ADæ ¼å¼ä»éœ€è¦Pythonç¯å¢ƒæ”¯æŒã€‚

```{r configure-python}
# é…ç½®Pythonç¯å¢ƒ
cat("é…ç½®Pythonç¯å¢ƒ...\n")

# æ–¹æ³•1: ä½¿ç”¨é»˜è®¤Pythonç¯å¢ƒï¼ˆæ¨èï¼‰
configure_python_env(verbose = TRUE)

# æ–¹æ³•2: æŒ‡å®šcondaç¯å¢ƒï¼ˆå¦‚æœä½¿ç”¨condaï¼‰
# configure_python_env(conda_env = "your_env_name", verbose = TRUE)

# æ–¹æ³•3: æŒ‡å®šPythonè·¯å¾„
# configure_python_env(python_path = "/usr/local/bin/python3", verbose = TRUE)

# éªŒè¯anndataå¯ç”¨æ€§
cat("\néªŒè¯anndataå¯ç”¨æ€§...\n")
check_anndata_available()
```

**ğŸ’¡ é…ç½®è¦ç‚¹:**

- è¿™ä¸€æ­¥éª¤è‡³å…³é‡è¦ï¼Œå¿…é¡»çœ‹åˆ°"âœ“ anndata is available"
- å¦‚æœé…ç½®å¤±è´¥ï¼Œè¯·ç¡®ä¿Pythonç¯å¢ƒä¸­å®‰è£…äº†anndataåŒ…
- å¯ä»¥é€šè¿‡`pip install anndata`æˆ–`conda install -c conda-forge anndata`å®‰è£…

## ç¬¬3æ­¥: å‡†å¤‡æ ·æœ¬ä¿¡æ¯CSVæ–‡ä»¶

`read_10x_mtx_to_h5ad()`å‡½æ•°éœ€è¦ä¸€ä¸ªCSVæ–‡ä»¶æ¥æè¿°æ‰€æœ‰æ ·æœ¬çš„æ–‡ä»¶è·¯å¾„ã€‚

### CSVæ–‡ä»¶æ ¼å¼è¦æ±‚

CSVæ–‡ä»¶å¿…é¡»åŒ…å«ä»¥ä¸‹4åˆ—ï¼š

- **Sample_id**: æ ·æœ¬æ ‡è¯†ç¬¦ï¼ˆå°†ç”¨äºç»†èƒIDé‡å‘½åï¼‰
- **mtx_fns**: matrix.mtxæ–‡ä»¶çš„å®Œæ•´è·¯å¾„
- **features_fns**: features.tsvæ–‡ä»¶çš„å®Œæ•´è·¯å¾„
- **barcodes_fns**: barcodes.tsvæ–‡ä»¶çš„å®Œæ•´è·¯å¾„

### ç¤ºä¾‹ï¼šåˆ›å»ºæ ·æœ¬ä¿¡æ¯CSV

```{r create-sample-csv}
# ç¤ºä¾‹1: åˆ›å»ºæ ·æœ¬ä¿¡æ¯è¡¨ï¼ˆè¯·æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹è·¯å¾„ï¼‰
sample_info <- data.frame(
  Sample_id = c("sample1", "sample2", "sample3"),
  mtx_fns = c(
    "/path/to/sample1/filtered_feature_bc_matrix/matrix.mtx.gz",
    "/path/to/sample2/filtered_feature_bc_matrix/matrix.mtx.gz", 
    "/path/to/sample3/filtered_feature_bc_matrix/matrix.mtx.gz"
  ),
  features_fns = c(
    "/path/to/sample1/filtered_feature_bc_matrix/features.tsv.gz",
    "/path/to/sample2/filtered_feature_bc_matrix/features.tsv.gz",
    "/path/to/sample3/filtered_feature_bc_matrix/features.tsv.gz"
  ),
  barcodes_fns = c(
    "/path/to/sample1/filtered_feature_bc_matrix/barcodes.tsv.gz",
    "/path/to/sample2/filtered_feature_bc_matrix/barcodes.tsv.gz",
    "/path/to/sample3/filtered_feature_bc_matrix/barcodes.tsv.gz"
  ),
  stringsAsFactors = FALSE
)

# ä¿å­˜ä¸ºCSVæ–‡ä»¶
csv_file <- "samples_info.csv"
write.csv(sample_info, csv_file, row.names = FALSE)

cat("âœ“ æ ·æœ¬ä¿¡æ¯CSVæ–‡ä»¶å·²åˆ›å»º:", csv_file, "\n")
cat("åŒ…å«", nrow(sample_info), "ä¸ªæ ·æœ¬\n")
```

### ç¤ºä¾‹ï¼šæ··åˆå‹ç¼©æ ¼å¼

```{r mixed-format-example}
# ç¤ºä¾‹2: æ··åˆå‹ç¼©æ ¼å¼ï¼ˆæœ‰äº›å‹ç¼©ï¼Œæœ‰äº›ä¸å‹ç¼©ï¼‰
sample_info_mixed <- data.frame(
  Sample_id = c("ctrl", "treat"),
  mtx_fns = c(
    "/path/to/ctrl/matrix.mtx.gz",     # å‹ç¼©æ ¼å¼
    "/path/to/treat/matrix.mtx"        # éå‹ç¼©æ ¼å¼
  ),
  features_fns = c(
    "/path/to/ctrl/features.tsv.gz",   # å‹ç¼©æ ¼å¼
    "/path/to/treat/genes.tsv"         # éå‹ç¼©ï¼Œä¸åŒæ–‡ä»¶å
  ),
  barcodes_fns = c(
    "/path/to/ctrl/barcodes.tsv.gz",   # å‹ç¼©æ ¼å¼  
    "/path/to/treat/barcodes.tsv"      # éå‹ç¼©æ ¼å¼
  ),
  stringsAsFactors = FALSE
)

write.csv(sample_info_mixed, "samples_mixed.csv", row.names = FALSE)
```

## ç¬¬4æ­¥: éªŒè¯æ–‡ä»¶è·¯å¾„

åœ¨è¿›è¡Œè½¬æ¢å‰ï¼ŒéªŒè¯æ‰€æœ‰æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®ï¼š

```{r verify-file-paths}
# è¯»å–CSVæ–‡ä»¶è¿›è¡ŒéªŒè¯
csv_file_to_check <- "samples_info.csv"  # ä½¿ç”¨æ‚¨çš„å®é™…CSVæ–‡ä»¶

if (file.exists(csv_file_to_check)) {
  cat("âœ“ æ‰¾åˆ°CSVæ–‡ä»¶:", csv_file_to_check, "\n")
  
  # è¯»å–æ–‡ä»¶å†…å®¹
  sample_data <- read.csv(csv_file_to_check, stringsAsFactors = FALSE)
  cat("CSVæ–‡ä»¶åŒ…å«", nrow(sample_data), "ä¸ªæ ·æœ¬\n")
  
  # æ˜¾ç¤ºæ–‡ä»¶ç»“æ„
  cat("\n=== CSVæ–‡ä»¶å†…å®¹é¢„è§ˆ ===\n")
  print(head(sample_data))
  
  # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼ˆä»…å½“è·¯å¾„æ˜¯çœŸå®è·¯å¾„æ—¶ï¼‰
  cat("\n=== æ–‡ä»¶å­˜åœ¨æ€§æ£€æŸ¥ ===\n")
  for (i in 1:nrow(sample_data)) {
    sample_id <- sample_data$Sample_id[i]
    
    # æ£€æŸ¥ä¸‰ä¸ªæ–‡ä»¶
    files_to_check <- c(
      mtx = sample_data$mtx_fns[i],
      features = sample_data$features_fns[i], 
      barcodes = sample_data$barcodes_fns[i]
    )
    
    cat("æ ·æœ¬", sample_id, ":\n")
    for (file_type in names(files_to_check)) {
      file_path <- files_to_check[file_type]
      if (file.exists(file_path)) {
        file_size_mb <- round(file.size(file_path) / 1024^2, 2)
        cat("  âœ“", file_type, "æ–‡ä»¶å­˜åœ¨ (", file_size_mb, "MB)\n")
      } else {
        cat("  âœ—", file_type, "æ–‡ä»¶ä¸å­˜åœ¨:", file_path, "\n")
      }
    }
  }
} else {
  cat("âœ— æ‰¾ä¸åˆ°CSVæ–‡ä»¶ï¼Œè¯·æ£€æŸ¥è·¯å¾„\n")
}
```

## ç¬¬5æ­¥: æ‰§è¡Œæ•°æ®è¯»å–å’Œæ•´åˆ

ç°åœ¨æ‰§è¡Œä¸»è¦çš„è½¬æ¢æ“ä½œï¼š

```{r read-and-integrate}
# è®¾ç½®è¾“å‡ºæ–‡ä»¶è·¯å¾„
output_h5ad <- "integrated_10x_data.h5ad"

cat("=== å¼€å§‹è¯»å–å’Œæ•´åˆ10Xæ•°æ® ===\n")

# æ‰§è¡Œè½¬æ¢
# ä¸»è¦å‚æ•°è¯´æ˜ï¼š
# - csv_file: åŒ…å«æ ·æœ¬ä¿¡æ¯çš„CSVæ–‡ä»¶è·¯å¾„
# - output_h5ad: è¾“å‡ºçš„H5ADæ–‡ä»¶è·¯å¾„
# - min_counts_per_cell: QCè¿‡æ»¤é˜ˆå€¼ï¼Œç§»é™¤æ€»è®¡æ•°ä½äºæ­¤å€¼çš„ç»†èƒ
# - verbose: æ˜¾ç¤ºè¯¦ç»†è¿›åº¦ä¿¡æ¯
result <- read_10x_mtx_to_h5ad(
  csv_file = csv_file_to_check,
  output_h5ad = output_h5ad,
  min_counts_per_cell = 200,    # é»˜è®¤QCé˜ˆå€¼
  verbose = TRUE                # æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
)

cat("âœ“ æ•°æ®æ•´åˆå®Œæˆï¼\n")
```

**ğŸ” å¤„ç†æµç¨‹è¯´æ˜:**

å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­ä¼šæ˜¾ç¤ºä»¥ä¸‹ä¿¡æ¯ï¼š

1. **è¯»å–CSVæ–‡ä»¶**: éªŒè¯æ–‡ä»¶æ ¼å¼å’Œè·¯å¾„
2. **é€ä¸ªå¤„ç†æ ·æœ¬**: 
   - è¯»å–MTXçŸ©é˜µï¼ˆä½¿ç”¨data.tableé«˜é€Ÿè¯»å–ï¼‰
   - è¯»å–åŸºå› æ³¨é‡Šï¼ˆfeatures/genesæ–‡ä»¶ï¼‰
   - è¯»å–ç»†èƒbarcodeï¼ˆbarcodesæ–‡ä»¶ï¼‰
   - åˆ›å»ºç¨€ç–çŸ©é˜µ
3. **è´¨é‡æ§åˆ¶**: ç§»é™¤æ€»è®¡æ•°ä½äºé˜ˆå€¼çš„ç»†èƒ
4. **ç»†èƒIDé‡å‘½å**: æ ¼å¼ä¸º `{Sample_id}_{åŸå§‹barcode}`
5. **æ•°æ®æ•´åˆ**: åˆå¹¶æ‰€æœ‰æ ·æœ¬çš„çŸ©é˜µ
6. **è¾“å‡ºH5AD**: ä¿å­˜ä¸ºAnnDataæ ¼å¼

## ç¬¬6æ­¥: éªŒè¯è½¬æ¢ç»“æœ

æ£€æŸ¥ç”Ÿæˆçš„H5ADæ–‡ä»¶ï¼š

```{r verify-results}
# æ£€æŸ¥è¾“å‡ºæ–‡ä»¶
if (file.exists(output_h5ad)) {
  cat("âœ“ H5ADæ–‡ä»¶åˆ›å»ºæˆåŠŸ!\n")
  cat("æ–‡ä»¶è·¯å¾„:", output_h5ad, "\n")
  
  # æ˜¾ç¤ºæ–‡ä»¶å¤§å°
  file_size_mb <- round(file.size(output_h5ad) / 1024^2, 2)
  cat("æ–‡ä»¶å¤§å°:", file_size_mb, "MB\n")
  
  # å°è¯•è¯»å–éªŒè¯
  tryCatch({
    # å¯¼å…¥anndata
    ad <- reticulate::import("anndata")
    
    # è¯»å–H5ADæ–‡ä»¶
    adata <- ad$read_h5ad(output_h5ad)
    
    cat("\n=== æ•´åˆæ•°æ®ä¿¡æ¯ ===\n")
    cat("æ€»ç»†èƒæ•°:", adata$shape[1], "\n")
    cat("æ€»åŸºå› æ•°:", adata$shape[2], "\n")
    
    # æ£€æŸ¥ç»†èƒæ³¨é‡Š
    cat("\n=== ç»†èƒæ³¨é‡Šä¿¡æ¯ ===\n")
    obs_columns <- names(adata$obs)
    cat("æ³¨é‡Šåˆ—:", paste(obs_columns, collapse = ", "), "\n")
    
    # æ˜¾ç¤ºæ ·æœ¬åˆ†å¸ƒ
    if ("sample_id" %in% obs_columns) {
      sample_counts <- table(adata$obs$sample_id)
      cat("\nå„æ ·æœ¬ç»†èƒæ•°é‡:\n")
      for (sample_name in names(sample_counts)) {
        cat("  ", sample_name, ":", sample_counts[[sample_name]], "ä¸ªç»†èƒ\n")
      }
    }
    
    # æ£€æŸ¥åŸºå› æ³¨é‡Š
    cat("\n=== åŸºå› æ³¨é‡Šä¿¡æ¯ ===\n")
    var_columns <- names(adata$var)
    cat("åŸºå› æ³¨é‡Šåˆ—:", paste(var_columns, collapse = ", "), "\n")
    
    # æ˜¾ç¤ºæ•°æ®ç¨€ç–æ€§
    if (inherits(adata$X, "scipy.sparse.csr.csr_matrix")) {
      sparsity <- 1 - (adata$X$nnz / (adata$shape[1] * adata$shape[2]))
      cat("æ•°æ®ç¨€ç–æ€§:", round(sparsity * 100, 2), "%\n")
    }
    
  }, error = function(e) {
    cat("æ— æ³•è¯»å–H5ADæ–‡ä»¶è¿›è¡ŒéªŒè¯:", e$message, "\n")
    cat("ä½†æ–‡ä»¶å·²æˆåŠŸåˆ›å»º\n")
  })
  
} else {
  cat("âœ— H5ADæ–‡ä»¶åˆ›å»ºå¤±è´¥\n")
}
```

## ç¬¬7æ­¥: é«˜çº§ä½¿ç”¨é€‰é¡¹

### è°ƒæ•´è´¨é‡æ§åˆ¶å‚æ•°

```{r advanced-qc}
# æ›´ä¸¥æ ¼çš„QCè¿‡æ»¤
read_10x_mtx_to_h5ad(
  csv_file = csv_file_to_check,
  output_h5ad = "integrated_strict_qc.h5ad",
  min_counts_per_cell = 500,    # æ›´é«˜çš„é˜ˆå€¼
  verbose = TRUE
)

# æ›´å®½æ¾çš„QCè¿‡æ»¤
read_10x_mtx_to_h5ad(
  csv_file = csv_file_to_check,
  output_h5ad = "integrated_loose_qc.h5ad", 
  min_counts_per_cell = 100,    # æ›´ä½çš„é˜ˆå€¼
  verbose = TRUE
)
```

### å¤„ç†å¤§æ•°æ®é›†çš„å»ºè®®

```{r large-dataset-tips}
# å¯¹äºå¤§æ•°æ®é›†ï¼ˆ>100ä¸‡ç»†èƒï¼‰ï¼Œå»ºè®®ï¼š

# 1. ç›‘æ§å†…å­˜ä½¿ç”¨
cat("å½“å‰å†…å­˜ä½¿ç”¨:\n")
gc()

# 2. åˆ†æ‰¹å¤„ç†ï¼ˆå¦‚æœæ ·æœ¬å¾ˆå¤šï¼‰
# å¯ä»¥å°†æ ·æœ¬åˆ†æˆå¤šä¸ªæ‰¹æ¬¡ï¼Œåˆ†åˆ«å¤„ç†åå†åˆå¹¶

# 3. ä½¿ç”¨æ›´ä¸¥æ ¼çš„QCå‡å°‘æ•°æ®é‡
# min_counts_per_cell = 1000  # æ›´ä¸¥æ ¼çš„è¿‡æ»¤

# 4. æ£€æŸ¥ç£ç›˜ç©ºé—´
# ç¡®ä¿æœ‰è¶³å¤Ÿç©ºé—´ä¿å­˜è¾“å‡ºæ–‡ä»¶
```

# ğŸ åœ¨Pythonä¸­ä½¿ç”¨æ•´åˆæ•°æ®

è½¬æ¢å®Œæˆåï¼Œæ‚¨å¯ä»¥åœ¨Pythonç¯å¢ƒä¸­åŠ è½½å’Œåˆ†ææ•°æ®ï¼š

```{python python-analysis, eval=FALSE}
import scanpy as sc
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns

# é…ç½®scanpy
sc.settings.verbosity = 3
sc.settings.set_figure_params(dpi=80, facecolor='white')

# è¯»å–æ•´åˆåçš„æ•°æ®
adata = sc.read_h5ad('integrated_10x_data.h5ad')

print(f"æ•°æ®ç»´åº¦: {adata.shape}")
print(f"æ ·æœ¬ä¿¡æ¯: {adata.obs['sample_id'].value_counts()}")

# åŸºæœ¬è´¨é‡æ§åˆ¶å¯è§†åŒ–
# è®¡ç®—é¢å¤–çš„QCæŒ‡æ ‡
adata.var['mt'] = adata.var_names.str.startswith('MT-')
sc.pp.calculate_qc_metrics(adata, percent_top=None, log1p=False, inplace=True)

# å¯è§†åŒ–QCæŒ‡æ ‡
fig, axes = plt.subplots(1, 3, figsize=(15, 5))

# UMIåˆ†å¸ƒ
sns.histplot(adata.obs['total_counts'], bins=50, ax=axes[0])
axes[0].set_xlabel('Total UMI counts')
axes[0].set_ylabel('Number of cells')

# åŸºå› æ•°åˆ†å¸ƒ  
sns.histplot(adata.obs['n_genes_by_counts'], bins=50, ax=axes[1])
axes[1].set_xlabel('Number of genes')
axes[1].set_ylabel('Number of cells')

# æ ·æœ¬åˆ†å¸ƒ
adata.obs['sample_id'].value_counts().plot(kind='bar', ax=axes[2])
axes[2].set_xlabel('Sample')
axes[2].set_ylabel('Number of cells')
axes[2].tick_params(axis='x', rotation=45)

plt.tight_layout()
plt.show()

# è¿›ä¸€æ­¥çš„è´¨é‡æ§åˆ¶
# è¿‡æ»¤ä½è´¨é‡ç»†èƒå’ŒåŸºå› 
sc.pp.filter_cells(adata, min_genes=200)  # è¿‡æ»¤è¡¨è¾¾åŸºå› æ•°<200çš„ç»†èƒ
sc.pp.filter_genes(adata, min_cells=3)    # è¿‡æ»¤åœ¨<3ä¸ªç»†èƒä¸­è¡¨è¾¾çš„åŸºå› 

# æ ‡å‡†åŒ–å’Œå¯¹æ•°è½¬æ¢
adata.raw = adata  # ä¿å­˜åŸå§‹æ•°æ®
sc.pp.normalize_total(adata, target_sum=1e4)  # æ ‡å‡†åŒ–åˆ°æ¯ä¸ªç»†èƒ10,000ä¸ªåˆ†å­
sc.pp.log1p(adata)  # å¯¹æ•°è½¬æ¢

# å¯»æ‰¾é«˜å˜åŸºå› 
sc.pp.highly_variable_genes(adata, min_mean=0.0125, max_mean=3, min_disp=0.5)
sc.pl.highly_variable_genes(adata)

# åªä¿ç•™é«˜å˜åŸºå› 
adata.raw = adata  # å†æ¬¡ä¿å­˜
adata = adata[:, adata.var.highly_variable]

# PCAåˆ†æ
sc.pp.scale(adata, max_value=10)  # ç¼©æ”¾æ•°æ®
sc.tl.pca(adata, svd_solver='arpack')
sc.pl.pca_variance_ratio(adata, log=True, n_top_genes=50)

# è®¡ç®—é‚»å±…å›¾å’ŒUMAP
sc.pp.neighbors(adata, n_neighbors=10, n_pcs=40)
sc.tl.umap(adata)

# èšç±»åˆ†æ
sc.tl.leiden(adata, resolution=0.5)

# å¯è§†åŒ–ç»“æœ
sc.pl.umap(adata, color=['sample_id', 'leiden'], legend_loc='on data')

# å¯»æ‰¾æ ‡è®°åŸºå› 
sc.tl.rank_genes_groups(adata, 'leiden', method='wilcoxon')
sc.pl.rank_genes_groups(adata, n_genes=5, sharey=False)
```

# ğŸ”§ å¸¸è§é—®é¢˜æ’æŸ¥

## é—®é¢˜1: CSVæ–‡ä»¶æ ¼å¼é”™è¯¯

**é”™è¯¯ä¿¡æ¯**: "Missing required columns" æˆ– "Invalid CSV format"

```{r csv-troubleshooting}
# æ£€æŸ¥CSVæ–‡ä»¶æ ¼å¼
csv_file_check <- "samples_info.csv"

if (file.exists(csv_file_check)) {
  # è¯»å–CSVæ–‡ä»¶
  csv_data <- read.csv(csv_file_check, stringsAsFactors = FALSE)
  
  # æ£€æŸ¥å¿…éœ€åˆ—
  required_cols <- c("Sample_id", "mtx_fns", "features_fns", "barcodes_fns")
  missing_cols <- setdiff(required_cols, colnames(csv_data))
  
  if (length(missing_cols) > 0) {
    cat("âœ— ç¼ºå°‘å¿…éœ€åˆ—:", paste(missing_cols, collapse = ", "), "\n")
    cat("å½“å‰åˆ—å:", paste(colnames(csv_data), collapse = ", "), "\n")
  } else {
    cat("âœ“ CSVæ–‡ä»¶æ ¼å¼æ­£ç¡®\n")
  }
  
  # æ£€æŸ¥æ•°æ®ç±»å‹
  cat("å„åˆ—æ•°æ®ç±»å‹:\n")
  str(csv_data)
  
} else {
  cat("âœ— CSVæ–‡ä»¶ä¸å­˜åœ¨\n")
}
```

## é—®é¢˜2: MTXæ–‡ä»¶è¯»å–å¤±è´¥

**é”™è¯¯ä¿¡æ¯**: "Error reading MTX file" æˆ– "Invalid matrix format"

```{r mtx-troubleshooting}
# æ‰‹åŠ¨æ£€æŸ¥MTXæ–‡ä»¶æ ¼å¼
test_mtx_file <- "path/to/your/matrix.mtx.gz"  # æ›¿æ¢ä¸ºå®é™…è·¯å¾„

if (file.exists(test_mtx_file)) {
  # è¯»å–å‰å‡ è¡Œæ£€æŸ¥æ ¼å¼
  if (grepl("\\.gz$", test_mtx_file)) {
    # å‹ç¼©æ–‡ä»¶
    conn <- gzfile(test_mtx_file, "r")
  } else {
    # éå‹ç¼©æ–‡ä»¶
    conn <- file(test_mtx_file, "r")
  }
  
  header_lines <- readLines(conn, n = 10)
  close(conn)
  
  cat("MTXæ–‡ä»¶å‰10è¡Œ:\n")
  for (i in seq_along(header_lines)) {
    cat(sprintf("%2d: %s\n", i, header_lines[i]))
  }
  
  # æ£€æŸ¥æ ¼å¼
  if (grepl("^%%MatrixMarket", header_lines[1])) {
    cat("âœ“ MTXæ–‡ä»¶æ ¼å¼æ­£ç¡®\n")
  } else {
    cat("âœ— MTXæ–‡ä»¶æ ¼å¼å¯èƒ½æœ‰é—®é¢˜\n")
  }
} else {
  cat("âœ— MTXæ–‡ä»¶ä¸å­˜åœ¨\n")
}
```

## é—®é¢˜3: å†…å­˜ä¸è¶³

**é”™è¯¯ä¿¡æ¯**: "Cannot allocate memory" æˆ–ç³»ç»Ÿå˜æ…¢

```{r memory-troubleshooting}
# å†…å­˜ç®¡ç†ç­–ç•¥
cat("=== å†…å­˜ä½¿ç”¨è¯Šæ–­ ===\n")

# æ£€æŸ¥å½“å‰å†…å­˜ä½¿ç”¨
gc_info <- gc()
cat("å½“å‰å†…å­˜ä½¿ç”¨:\n")
print(gc_info)

# è·å–ç³»ç»Ÿå†…å­˜ä¿¡æ¯ï¼ˆLinux/Macï¼‰
tryCatch({
  if (Sys.info()["sysname"] == "Linux") {
    mem_info <- system("free -h", intern = TRUE)
    cat("ç³»ç»Ÿå†…å­˜ä¿¡æ¯:\n")
    cat(paste(mem_info, collapse = "\n"), "\n")
  }
}, error = function(e) {
  cat("æ— æ³•è·å–ç³»ç»Ÿå†…å­˜ä¿¡æ¯\n")
})

# å†…å­˜ä¼˜åŒ–å»ºè®®
cat("\n=== å†…å­˜ä¼˜åŒ–å»ºè®® ===\n")
cat("1. æé«˜QCé˜ˆå€¼å‡å°‘ç»†èƒæ•°: min_counts_per_cell = 500\n")
cat("2. åˆ†æ‰¹å¤„ç†å¤§æ•°æ®é›†\n")
cat("3. ä½¿ç”¨æ›´å¤šRAMæˆ–äº‘è®¡ç®—å¹³å°\n")
cat("4. æ¸…ç†ç¯å¢ƒ: rm(unused_objects); gc()\n")
```

## é—®é¢˜4: Pythonç¯å¢ƒé—®é¢˜

**é”™è¯¯ä¿¡æ¯**: "anndata not available" æˆ– Pythonç›¸å…³é”™è¯¯

```{r python-troubleshooting}
# Pythonç¯å¢ƒè¯Šæ–­
cat("=== Pythonç¯å¢ƒè¯Šæ–­ ===\n")

# æ£€æŸ¥reticulateé…ç½®
py_config <- reticulate::py_config()
cat("Pythonè·¯å¾„:", py_config$python, "\n")
cat("Pythonç‰ˆæœ¬:", py_config$version, "\n")

# æ£€æŸ¥å¯ç”¨çš„condaç¯å¢ƒ
tryCatch({
  conda_envs <- reticulate::conda_list()
  if (nrow(conda_envs) > 0) {
    cat("å¯ç”¨çš„condaç¯å¢ƒ:\n")
    print(conda_envs[, c("name", "python")])
  }
}, error = function(e) {
  cat("æ— æ³•åˆ—å‡ºcondaç¯å¢ƒ\n")
})

# æµ‹è¯•anndataå¯¼å…¥
tryCatch({
  ad <- reticulate::import("anndata")
  cat("âœ“ anndataå¯¼å…¥æˆåŠŸï¼Œç‰ˆæœ¬:", ad$`__version__`, "\n")
}, error = function(e) {
  cat("âœ— anndataå¯¼å…¥å¤±è´¥:", e$message, "\n")
  cat("è§£å†³æ–¹æ³•: pip install anndata\n")
})
```

## é—®é¢˜5: åŸºå› åä¸ä¸€è‡´

**é”™è¯¯ä¿¡æ¯**: "Gene names differ between samples"

```{r gene-consistency}
# æ£€æŸ¥å¤šä¸ªæ ·æœ¬çš„åŸºå› ä¸€è‡´æ€§
check_gene_consistency <- function(csv_file) {
  if (!file.exists(csv_file)) {
    cat("CSVæ–‡ä»¶ä¸å­˜åœ¨\n")
    return()
  }
  
  sample_data <- read.csv(csv_file, stringsAsFactors = FALSE)
  
  cat("æ£€æŸ¥åŸºå› åä¸€è‡´æ€§...\n")
  
  all_genes <- list()
  
  for (i in 1:min(nrow(sample_data), 3)) {  # åªæ£€æŸ¥å‰3ä¸ªæ ·æœ¬
    features_file <- sample_data$features_fns[i]
    
    if (file.exists(features_file)) {
      # è¯»å–featuresæ–‡ä»¶
      features <- data.table::fread(features_file, header = FALSE)
      genes <- features[[2]]  # ç¬¬äºŒåˆ—é€šå¸¸æ˜¯åŸºå› å
      
      all_genes[[sample_data$Sample_id[i]]] <- genes
      cat("æ ·æœ¬", sample_data$Sample_id[i], ":", length(genes), "ä¸ªåŸºå› \n")
    }
  }
  
  # æ£€æŸ¥åŸºå› ä¸€è‡´æ€§
  if (length(all_genes) > 1) {
    first_genes <- all_genes[[1]]
    consistent <- TRUE
    
    for (i in 2:length(all_genes)) {
      if (!identical(first_genes, all_genes[[i]])) {
        consistent <- FALSE
        break
      }
    }
    
    if (consistent) {
      cat("âœ“ æ‰€æœ‰æ ·æœ¬åŸºå› åä¸€è‡´\n")
    } else {
      cat("âš  æ ·æœ¬é—´åŸºå› åä¸ä¸€è‡´ï¼Œå°†ä½¿ç”¨åŸºå› äº¤é›†\n")
      
      # è®¡ç®—äº¤é›†
      common_genes <- Reduce(intersect, all_genes)
      cat("å…±åŒåŸºå› æ•°:", length(common_genes), "\n")
    }
  }
}

# è¿è¡Œæ£€æŸ¥
check_gene_consistency("samples_info.csv")
```

# ğŸ“Š æ€§èƒ½åŸºå‡†æµ‹è¯•

```{r performance-benchmark}
# ç®€å•çš„æ€§èƒ½æµ‹è¯•
benchmark_reading <- function() {
  cat("=== æ€§èƒ½åŸºå‡†æµ‹è¯• ===\n")
  
  # è®°å½•å¼€å§‹æ—¶é—´
  start_time <- Sys.time()
  
  # æ¨¡æ‹Ÿå°è§„æ¨¡æµ‹è¯•ï¼ˆå¦‚æœæœ‰æµ‹è¯•æ•°æ®ï¼‰
  cat("å¼€å§‹æ—¶é—´:", format(start_time), "\n")
  
  # è¿™é‡Œå¯ä»¥è¿è¡Œå®é™…çš„è½¬æ¢æµ‹è¯•
  # result <- read_10x_mtx_to_h5ad(...)
  
  # è®°å½•ç»“æŸæ—¶é—´
  end_time <- Sys.time()
  elapsed <- difftime(end_time, start_time, units = "mins")
  
  cat("ç»“æŸæ—¶é—´:", format(end_time), "\n")
  cat("æ€»è€—æ—¶:", round(elapsed, 2), "åˆ†é’Ÿ\n")
  
  # å†…å­˜ä½¿ç”¨ç»Ÿè®¡
  gc_final <- gc()
  cat("æœ€ç»ˆå†…å­˜ä½¿ç”¨:\n")
  print(gc_final)
}

# å¦‚æœæœ‰æµ‹è¯•æ•°æ®ï¼Œå¯ä»¥è¿è¡ŒåŸºå‡†æµ‹è¯•
# benchmark_reading()
```

# ğŸ’¡ æœ€ä½³å®è·µå’Œå»ºè®®

## æ•°æ®å‡†å¤‡å»ºè®®

1. **æ–‡ä»¶ç»„ç»‡**: ä¿æŒä¸€è‡´çš„ç›®å½•ç»“æ„
2. **è·¯å¾„ç®¡ç†**: ä½¿ç”¨ç»å¯¹è·¯å¾„é¿å…è·¯å¾„é—®é¢˜  
3. **å¤‡ä»½æ•°æ®**: å¤„ç†å‰å¤‡ä»½åŸå§‹æ•°æ®
4. **ç‰ˆæœ¬è®°å½•**: è®°å½•ä½¿ç”¨çš„è½¯ä»¶ç‰ˆæœ¬

## è´¨é‡æ§åˆ¶å»ºè®®

```{r qc-recommendations}
cat("=== è´¨é‡æ§åˆ¶å‚æ•°å»ºè®® ===\n")
cat("ç»†èƒç±»å‹           | min_counts_per_cell å»ºè®®å€¼\n")
cat("é«˜è´¨é‡PBMC        | 200-500\n")  
cat("ç»„ç»‡æ ·æœ¬          | 500-1000\n")
cat("å•ç»†èƒæ ¸RNA-seq   | 100-300\n")
cat("10X v3åŒ–å­¦è¯•å‰‚    | 500-1000\n")
cat("10X v2åŒ–å­¦è¯•å‰‚    | 200-500\n")
```

## è®¡ç®—èµ„æºå»ºè®®

```{r resource-recommendations}
cat("=== è®¡ç®—èµ„æºå»ºè®® ===\n")
cat("æ•°æ®è§„æ¨¡          | å†…å­˜éœ€æ±‚    | å»ºè®®é…ç½®\n")
cat("< 10,000ç»†èƒ     | 4-8 GB     | æ™®é€šPC\n")
cat("10,000-50,000ç»†èƒ| 8-16 GB    | å·¥ä½œç«™\n") 
cat("50,000-100,000ç»†èƒ| 16-32 GB   | é«˜é…å·¥ä½œç«™\n")
cat("> 100,000ç»†èƒ    | 32+ GB     | æœåŠ¡å™¨/äº‘è®¡ç®—\n")
```

# ğŸ“š ä¸‹ä¸€æ­¥åˆ†æ

æ•´åˆå®Œæˆåï¼Œå»ºè®®çš„åˆ†ææµç¨‹ï¼š

## åœ¨Pythonä¸­çš„åˆ†æ

1. **è´¨é‡æ§åˆ¶**: æ›´ç²¾ç»†çš„QCå’Œè¿‡æ»¤
2. **æ ‡å‡†åŒ–**: æ•°æ®æ ‡å‡†åŒ–å’Œå¯¹æ•°è½¬æ¢
3. **ç‰¹å¾é€‰æ‹©**: å¯»æ‰¾é«˜å˜åŸºå› 
4. **é™ç»´**: PCAå’ŒUMAPåˆ†æ
5. **èšç±»**: leidenæˆ–louvainèšç±»
6. **æ³¨é‡Š**: ç»†èƒç±»å‹æ³¨é‡Š
7. **å·®å¼‚åˆ†æ**: æ ‡è®°åŸºå› è¯†åˆ«

## æ¨èå·¥å…·é“¾

- **scanpy**: æ ¸å¿ƒåˆ†ææµç¨‹
- **scvelo**: RNA velocityåˆ†æ
- **cellrank**: ç»†èƒå‘½è¿é¢„æµ‹
- **scanorama**: æ‰¹æ¬¡æ•ˆåº”æ ¡æ­£
- **squidpy**: ç©ºé—´è½¬å½•ç»„ï¼ˆå¦‚æœé€‚ç”¨ï¼‰

# ğŸ”— ç›¸å…³èµ„æº

## å®˜æ–¹æ–‡æ¡£

- [10X Genomicsæ–‡æ¡£](https://support.10xgenomics.com/)
- [scanpyæ•™ç¨‹](https://scanpy-tutorials.readthedocs.io/)
- [AnnDataæ–‡æ¡£](https://anndata.readthedocs.io/)

## ç›¸å…³æ•™ç¨‹

- æ•™ç¨‹1: 1CellBioè½¬H5AD
- æ•™ç¨‹2: 1CellBioè½¬Seurat
- æ•™ç¨‹3: Seuratè½¬H5AD

---

**éœ€è¦å¸®åŠ©ï¼Ÿ**

- æŸ¥çœ‹å‡½æ•°æ–‡æ¡£: `?read_10x_mtx_to_h5ad`
- GitHub Issues: [é¡¹ç›®åœ°å€]
- è”ç³»ç»´æŠ¤è€…: [é‚®ç®±åœ°å€]

**å°è´´å£«**: ç¬¬ä¸€æ¬¡ä½¿ç”¨å»ºè®®å…ˆç”¨å°æ•°æ®é›†æµ‹è¯•ï¼Œç¡®è®¤æµç¨‹æ— è¯¯åå†å¤„ç†å¤§æ•°æ®é›†ã€‚