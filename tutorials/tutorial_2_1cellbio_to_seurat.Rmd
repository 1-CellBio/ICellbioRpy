---
title: "æ•™ç¨‹2: å°†1CellBio ZIPæ–‡ä»¶è½¬æ¢ä¸ºSeuratå¯¹è±¡"
author: "ICellbioRpyæ•™ç¨‹"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: show
    theme: cosmo
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, eval = FALSE)
```

# ğŸ¯ æ•™ç¨‹ç›®æ ‡

åœ¨è¿™ä¸ªæ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•ä½¿ç”¨`ICellbioRpy`åŒ…å°†1CellBioåˆ†æç»“æœçš„ZIPæ–‡ä»¶è½¬æ¢ä¸ºSeuratå¯¹è±¡ï¼Œæ–¹ä¾¿åœ¨Rä¸­è¿›è¡Œå•ç»†èƒæ•°æ®åˆ†æã€‚

# ğŸ“‹ å‰ææ¡ä»¶

## å¿…éœ€çš„RåŒ…

```{r required-packages, eval=TRUE}
# æ£€æŸ¥å¿…éœ€åŒ…æ˜¯å¦å®‰è£…
required_packages <- c("Seurat", "Matrix", "hdf5r", "jsonlite")
missing_packages <- required_packages[!sapply(required_packages, requireNamespace, quietly = TRUE)]

if (length(missing_packages) > 0) {
  cat("éœ€è¦å®‰è£…ä»¥ä¸‹åŒ…:", paste(missing_packages, collapse = ", "), "\n")
  cat("è¯·è¿è¡Œ: install.packages(c(", paste0("'", missing_packages, "'", collapse = ", "), "))\n")
} else {
  cat("âœ“ æ‰€æœ‰å¿…éœ€åŒ…å·²å®‰è£…\n")
}
```

# ğŸš€ å¼€å§‹æ•™ç¨‹

## ç¬¬1æ­¥: å®‰è£…å’ŒåŠ è½½åŒ…

```{r load-packages}
# åŠ è½½ICellbioRpyåŒ…
library(ICellbioRpy)

# åŠ è½½Seuratå’Œå…¶ä»–å¿…éœ€åŒ…
library(Seurat)
library(Matrix)
library(dplyr)
library(ggplot2)

# æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
cat("ICellbioRpyç‰ˆæœ¬:", as.character(packageVersion("ICellbioRpy")), "\n")
cat("Seuratç‰ˆæœ¬:", as.character(packageVersion("Seurat")), "\n")
```

## ç¬¬2æ­¥: é…ç½®Pythonç¯å¢ƒï¼ˆé‡è¦ï¼ï¼‰

å³ä½¿æˆ‘ä»¬è¦è½¬æ¢ä¸ºSeuratå¯¹è±¡ï¼Œä»ç„¶éœ€è¦é…ç½®Pythonç¯å¢ƒï¼Œå› ä¸ºè¯»å–1CellBioæ•°æ®çš„æŸäº›æ­¥éª¤éœ€è¦Pythonæ”¯æŒã€‚

```{r configure-python}
# é…ç½®Pythonç¯å¢ƒ
configure_python_env(verbose = TRUE)

# æ£€æŸ¥anndataæ˜¯å¦å¯ç”¨
# æ³¨æ„ï¼šå³ä½¿è½¬æ¢ä¸ºSeuratï¼Œè¿™ä¸ªæ£€æŸ¥ä»ç„¶æ˜¯å¿…éœ€çš„
check_anndata_available()
```

**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦Pythonç¯å¢ƒï¼Ÿ**

1CellBioçš„æŸäº›æ•°æ®ç»„ä»¶ä½¿ç”¨äº†ç‰¹å®šçš„å­˜å‚¨æ ¼å¼ï¼Œéœ€è¦Pythonåº“æ¥æ­£ç¡®è¯»å–
å³ä½¿æœ€ç»ˆè¾“å‡ºæ˜¯Seuratå¯¹è±¡ï¼Œä¸­é—´æ­¥éª¤ä»éœ€è¦Pythonæ”¯æŒ

## ç¬¬3æ­¥: å‡†å¤‡æ•°æ®æ–‡ä»¶

```{r prepare-data}
# è®¾ç½®æ‚¨çš„1CellBio ZIPæ–‡ä»¶è·¯å¾„
zip_file_path <- "path/to/your/1cellbio_results.zip"

# éªŒè¯æ–‡ä»¶å­˜åœ¨
if (file.exists(zip_file_path)) {
  cat("âœ“ æ‰¾åˆ°ZIPæ–‡ä»¶:", zip_file_path, "\n")
  
  # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
  file_info <- file.info(zip_file_path)
  cat("æ–‡ä»¶å¤§å°:", round(file_info$size / 1024^2, 2), "MB\n")
  cat("ä¿®æ”¹æ—¶é—´:", as.character(file_info$mtime), "\n")
} else {
  cat("âœ— æ‰¾ä¸åˆ°ZIPæ–‡ä»¶ï¼Œè¯·æ£€æŸ¥è·¯å¾„\n")
  cat("è¯·å°† 'path/to/your/1cellbio_results.zip' æ›¿æ¢ä¸ºå®é™…çš„æ–‡ä»¶è·¯å¾„\n")
}
```

## ç¬¬4æ­¥: è¯»å–1CellBioæ•°æ®

ä½¿ç”¨`read1Cellbio()`å‡½æ•°è¯»å–æ•°æ®ï¼š

```{r read-data}
# è¯»å–1CellBioæ•°æ®
# è¿™ä¸ªå‡½æ•°ä¼šè§£å‹ZIPæ–‡ä»¶å¹¶è¯»å–æ‰€æœ‰ç»„ä»¶
cat("å¼€å§‹è¯»å–1CellBioæ•°æ®...\n")

cellbio_data <- read1Cellbio(
  zip_path = zip_file_path,
  verbose = TRUE  # æ˜¾ç¤ºè¯¦ç»†è¿›åº¦
)

# æŸ¥çœ‹æ•°æ®ç»“æ„
cat("æ•°æ®è¯»å–å®Œæˆï¼\n")
cat("æ•°æ®ç±»å‹:", class(cellbio_data), "\n")
```

**ğŸ” è¯»å–è¿‡ç¨‹è¯´æ˜ï¼š**

`read1Cellbio()`å‡½æ•°ä¼šæ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š

1. **è§£å‹ZIPæ–‡ä»¶**: æå–åˆ°ä¸´æ—¶ç›®å½•
2. **è§£æå…ƒæ•°æ®**: è¯»å–å®éªŒé…ç½®ä¿¡æ¯
3. **åŠ è½½è¡¨è¾¾çŸ©é˜µ**: è¯»å–åŸºå› è¡¨è¾¾æ•°æ®ï¼ˆç¨€ç–æ ¼å¼ï¼‰
4. **åŠ è½½æ³¨é‡Šæ•°æ®**: è¯»å–ç»†èƒå’ŒåŸºå› çš„æ³¨é‡Šä¿¡æ¯
5. **åŠ è½½é™ç»´ç»“æœ**: è¯»å–PCAã€UMAPã€t-SNEç­‰ç»“æœ
6. **åˆ›å»ºæ•°æ®å¯¹è±¡**: ç»„è£…æˆ1CellbioDataå¯¹è±¡

## ç¬¬5æ­¥: è½¬æ¢ä¸ºSeuratå¯¹è±¡

ç°åœ¨å°†1CellbioDataå¯¹è±¡è½¬æ¢ä¸ºSeuratå¯¹è±¡ï¼š

```{r convert-to-seurat}
# è½¬æ¢ä¸ºSeuratå¯¹è±¡ï¼ˆéœ€è¦æŒ‡å®šåŸºå› åå’Œç»†èƒååˆ—ï¼‰
seurat_obj <- as.Seurat(cellbio_data,
                       rownames = "id",        # åŸºå› ååˆ—
                       colnames = "cell_id")   # ç»†èƒååˆ—

# æˆ–è€…æ–¹æ³•2: ä½¿ç”¨åŸå§‹è½¬æ¢å‡½æ•°
# seurat_obj <- as.Seurat.1CellbioData(cellbio_data)

cat("âœ“ è½¬æ¢ä¸ºSeuratå¯¹è±¡å®Œæˆï¼\n")
```

## ç¬¬6æ­¥: æ£€æŸ¥è½¬æ¢ç»“æœ

è®©æˆ‘ä»¬è¯¦ç»†æ£€æŸ¥è½¬æ¢åçš„Seuratå¯¹è±¡ï¼š

```{r examine-seurat}
# åŸºæœ¬ä¿¡æ¯
cat("=== Seuratå¯¹è±¡åŸºæœ¬ä¿¡æ¯ ===\n")
print(seurat_obj)

# æ•°æ®ç»´åº¦
cat("\n=== æ•°æ®ç»´åº¦ ===\n")
cat("ç»†èƒæ•°é‡:", ncol(seurat_obj), "\n")
cat("åŸºå› æ•°é‡:", nrow(seurat_obj), "\n")

# æ£€æŸ¥assays
cat("\n=== å¯ç”¨çš„Assays ===\n")
cat("Assays:", names(seurat_obj@assays), "\n")
cat("é»˜è®¤assay:", DefaultAssay(seurat_obj), "\n")

# æ£€æŸ¥å…ƒæ•°æ®
cat("\n=== ç»†èƒå…ƒæ•°æ® ===\n")
cat("å…ƒæ•°æ®åˆ—æ•°:", ncol(seurat_obj@meta.data), "\n")
cat("å…ƒæ•°æ®åˆ—å:\n")
print(colnames(seurat_obj@meta.data))

# æ˜¾ç¤ºå‰å‡ è¡Œå…ƒæ•°æ®
cat("\n=== å…ƒæ•°æ®é¢„è§ˆ ===\n")
head(seurat_obj@meta.data, 3)

# æ£€æŸ¥é™ç»´ç»“æœ
cat("\n=== é™ç»´ç»“æœ ===\n")
if (length(seurat_obj@reductions) > 0) {
  cat("å¯ç”¨çš„é™ç»´:", names(seurat_obj@reductions), "\n")
  for (reduction_name in names(seurat_obj@reductions)) {
    dims <- dim(seurat_obj@reductions[[reduction_name]]@cell.embeddings)
    cat(sprintf("%s: %dç»´åº¦\n", reduction_name, dims[2]))
  }
} else {
  cat("æ— é™ç»´ç»“æœ\n")
}
```

## ç¬¬7æ­¥: æ•°æ®è´¨é‡æ£€æŸ¥

è¿›è¡ŒåŸºæœ¬çš„æ•°æ®è´¨é‡æ£€æŸ¥ï¼š

```{r quality-check}
# è®¡ç®—åŸºæœ¬QCæŒ‡æ ‡ï¼ˆå¦‚æœè¿˜æ²¡æœ‰çš„è¯ï¼‰
if (!"nCount_RNA" %in% colnames(seurat_obj@meta.data)) {
  seurat_obj[["percent.mt"]] <- PercentageFeatureSet(seurat_obj, pattern = "^MT-")
  seurat_obj[["nCount_RNA"]] <- colSums(seurat_obj@assays$RNA@counts)
  seurat_obj[["nFeature_RNA"]] <- colSums(seurat_obj@assays$RNA@counts > 0)
}

# æ˜¾ç¤ºQCç»Ÿè®¡
cat("=== è´¨é‡æ§åˆ¶ç»Ÿè®¡ ===\n")
qc_stats <- seurat_obj@meta.data %>%
  summarise(
    ç»†èƒæ•° = n(),
    å¹³å‡åŸºå› æ•° = round(mean(nFeature_RNA, na.rm = TRUE)),
    å¹³å‡UMIæ•° = round(mean(nCount_RNA, na.rm = TRUE)),
    .groups = 'drop'
  )
print(qc_stats)

# QCæŒ‡æ ‡åˆ†å¸ƒ
if (requireNamespace("ggplot2", quietly = TRUE)) {
  # UMIè®¡æ•°åˆ†å¸ƒ
  p1 <- VlnPlot(seurat_obj, features = c("nFeature_RNA", "nCount_RNA"), ncol = 2)
  print(p1)
  
  # å¦‚æœæœ‰çº¿ç²’ä½“åŸºå› ä¿¡æ¯
  if ("percent.mt" %in% colnames(seurat_obj@meta.data)) {
    p2 <- VlnPlot(seurat_obj, features = "percent.mt")
    print(p2)
  }
}
```

## ç¬¬8æ­¥: å¯è§†åŒ–é™ç»´ç»“æœï¼ˆå¦‚æœæœ‰ï¼‰

å¦‚æœæ•°æ®åŒ…å«é™ç»´ç»“æœï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å¯è§†åŒ–ï¼š

```{r visualize-reductions}
# æ£€æŸ¥å¹¶å¯è§†åŒ–UMAP
if ("umap" %in% names(seurat_obj@reductions)) {
  cat("ç»˜åˆ¶UMAPå›¾...\n")
  
  # åŸºæœ¬UMAPå›¾
  p_umap <- DimPlot(seurat_obj, reduction = "umap", group.by = "seurat_clusters") +
    ggtitle("UMAPé™ç»´ç»“æœ")
  print(p_umap)
  
  # å¦‚æœæœ‰ç»†èƒç±»å‹æ³¨é‡Š
  if ("cell_type" %in% colnames(seurat_obj@meta.data)) {
    p_umap_celltype <- DimPlot(seurat_obj, reduction = "umap", group.by = "cell_type") +
      ggtitle("UMAP - ç»†èƒç±»å‹")
    print(p_umap_celltype)
  }
}

# æ£€æŸ¥å¹¶å¯è§†åŒ–t-SNE
if ("tsne" %in% names(seurat_obj@reductions)) {
  cat("ç»˜åˆ¶t-SNEå›¾...\n")
  p_tsne <- DimPlot(seurat_obj, reduction = "tsne", group.by = "seurat_clusters") +
    ggtitle("t-SNEé™ç»´ç»“æœ")
  print(p_tsne)
}

# æ£€æŸ¥å¹¶å¯è§†åŒ–PCA
if ("pca" %in% names(seurat_obj@reductions)) {
  cat("ç»˜åˆ¶PCAå›¾...\n")
  p_pca <- DimPlot(seurat_obj, reduction = "pca", group.by = "seurat_clusters") +
    ggtitle("PCAé™ç»´ç»“æœ")
  print(p_pca)
  
  # PCAè´¡çŒ®åº¦
  p_elbow <- ElbowPlot(seurat_obj, ndims = 20)
  print(p_elbow)
}
```

## ç¬¬9æ­¥: ä¿å­˜Seuratå¯¹è±¡

å°†è½¬æ¢åçš„Seuratå¯¹è±¡ä¿å­˜ä»¥å¤‡åç»­ä½¿ç”¨ï¼š

```{r save-seurat}
# ä¿å­˜ä¸ºRDSæ–‡ä»¶ï¼ˆæ¨èæ ¼å¼ï¼‰
output_file <- "1cellbio_seurat_object.rds"

saveRDS(seurat_obj, file = output_file)
cat("âœ“ Seuratå¯¹è±¡å·²ä¿å­˜åˆ°:", output_file, "\n")

# æ£€æŸ¥ä¿å­˜çš„æ–‡ä»¶
if (file.exists(output_file)) {
  file_size <- round(file.size(output_file) / 1024^2, 2)
  cat("æ–‡ä»¶å¤§å°:", file_size, "MB\n")
}

# éªŒè¯ä¿å­˜å’ŒåŠ è½½
cat("\néªŒè¯ä¿å­˜/åŠ è½½åŠŸèƒ½...\n")
test_obj <- readRDS(output_file)
cat("âœ“ æ–‡ä»¶è¯»å–æˆåŠŸï¼Œç»†èƒæ•°:", ncol(test_obj), "ï¼ŒåŸºå› æ•°:", nrow(test_obj), "\n")
```

# ğŸ”¬ è¿›é˜¶åˆ†æç¤ºä¾‹

ç°åœ¨æ‚¨æœ‰äº†Seuratå¯¹è±¡ï¼Œå¯ä»¥è¿›è¡Œæ ‡å‡†çš„å•ç»†èƒåˆ†æï¼š

## é‡æ–°èšç±»åˆ†æ

```{r advanced-analysis}
# å¦‚æœéœ€è¦é‡æ–°è¿›è¡Œèšç±»åˆ†æ
if (!"seurat_clusters" %in% colnames(seurat_obj@meta.data)) {
  cat("æ‰§è¡Œèšç±»åˆ†æ...\n")
  
  # æ ‡å‡†åŒ–æ•°æ®
  seurat_obj <- NormalizeData(seurat_obj)
  
  # æ‰¾åˆ°é«˜å˜åŸºå› 
  seurat_obj <- FindVariableFeatures(seurat_obj, selection.method = "vst", nfeatures = 2000)
  
  # ç¼©æ”¾æ•°æ®
  seurat_obj <- ScaleData(seurat_obj)
  
  # PCA
  seurat_obj <- RunPCA(seurat_obj, features = VariableFeatures(object = seurat_obj))
  
  # èšç±»
  seurat_obj <- FindNeighbors(seurat_obj, dims = 1:10)
  seurat_obj <- FindClusters(seurat_obj, resolution = 0.5)
  
  # UMAP
  seurat_obj <- RunUMAP(seurat_obj, dims = 1:10)
  
  cat("âœ“ èšç±»åˆ†æå®Œæˆ\n")
}
```

## å·®å¼‚åŸºå› åˆ†æ

```{r differential-genes}
# å¯»æ‰¾æ ‡è®°åŸºå› 
if ("seurat_clusters" %in% colnames(seurat_obj@meta.data)) {
  cat("å¯»æ‰¾èšç±»æ ‡è®°åŸºå› ...\n")
  
  # å¯»æ‰¾æ‰€æœ‰èšç±»çš„æ ‡è®°åŸºå› 
  cluster_markers <- FindAllMarkers(seurat_obj, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25)
  
  # æ˜¾ç¤ºæ¯ä¸ªèšç±»çš„å‰5ä¸ªæ ‡è®°åŸºå› 
  top_markers <- cluster_markers %>%
    group_by(cluster) %>%
    slice_max(n = 5, order_by = avg_log2FC)
  
  cat("æ¯ä¸ªèšç±»çš„å‰5ä¸ªæ ‡è®°åŸºå› :\n")
  print(top_markers)
}
```

# ğŸ”§ å¸¸è§é—®é¢˜æ’æŸ¥

## é—®é¢˜1: Pythonç¯å¢ƒé…ç½®å¤±è´¥

**ç—‡çŠ¶**: å‡ºç°Pythonç›¸å…³é”™è¯¯
**è§£å†³æ–¹æ³•**:

```{r troubleshoot-python-seurat}
# æ£€æŸ¥å½“å‰Pythoné…ç½®
reticulate::py_config()

# é‡æ–°é…ç½®Pythonç¯å¢ƒ
configure_python_env(conda_env = "base", verbose = TRUE)

# æˆ–æŒ‡å®šPythonè·¯å¾„
# configure_python_env(python_path = "/usr/local/bin/python3")
```

## é—®é¢˜2: å†…å­˜ä¸è¶³

**ç—‡çŠ¶**: "Cannot allocate memory" é”™è¯¯
**è§£å†³æ–¹æ³•**:

```{r memory-management}
# æ¸…ç†å†…å­˜
gc()

# æ£€æŸ¥å¯¹è±¡å¤§å°
object.size(seurat_obj)

# å¦‚æœå†…å­˜ä¸è¶³ï¼Œå¯ä»¥åªä¿ç•™é‡è¦æ•°æ®
# ä¾‹å¦‚ï¼Œåˆ é™¤ä¸å¿…è¦çš„assaysæˆ–é™ç»´ç»“æœ
```

## é—®é¢˜3: é™ç»´ç»“æœç¼ºå¤±

**ç—‡çŠ¶**: æ²¡æœ‰UMAPæˆ–t-SNEç»“æœ
**è§£å†³æ–¹æ³•**:

```{r missing-reductions}
# æ£€æŸ¥åŸå§‹æ•°æ®æ˜¯å¦åŒ…å«é™ç»´ç»“æœ
if (length(seurat_obj@reductions) == 0) {
  cat("åŸå§‹æ•°æ®ä¸åŒ…å«é™ç»´ç»“æœï¼Œéœ€è¦é‡æ–°è®¡ç®—\n")
  
  # é‡æ–°è®¡ç®—PCAå’ŒUMAP
  seurat_obj <- RunPCA(seurat_obj)
  seurat_obj <- RunUMAP(seurat_obj, dims = 1:10)
}
```

## é—®é¢˜4: å…ƒæ•°æ®ä¿¡æ¯ç¼ºå¤±

**ç—‡çŠ¶**: ç¼ºå°‘ç»†èƒç±»å‹æˆ–å…¶ä»–æ³¨é‡Š
**è§£å†³æ–¹æ³•**:

```{r missing-metadata}
# æ£€æŸ¥å¯ç”¨çš„å…ƒæ•°æ®åˆ—
colnames(seurat_obj@meta.data)

# å¦‚æœéœ€è¦æ·»åŠ æ–°çš„å…ƒæ•°æ®ï¼Œå¯ä»¥æ‰‹åŠ¨æ·»åŠ 
# seurat_obj$new_annotation <- "value"
```

# ğŸ“š ä¸‹ä¸€æ­¥åˆ†æå»ºè®®

æˆåŠŸè½¬æ¢ä¸ºSeuratå¯¹è±¡åï¼Œæ‚¨å¯ä»¥ï¼š

1. **è´¨é‡æ§åˆ¶**: è¿‡æ»¤ä½è´¨é‡ç»†èƒå’ŒåŸºå› 
2. **èšç±»åˆ†æ**: è¯†åˆ«ç»†èƒç¾¤ä½“
3. **å·®å¼‚åŸºå› åˆ†æ**: æ‰¾åˆ°æ ‡è®°åŸºå› 
4. **åŠŸèƒ½æ³¨é‡Š**: è¿›è¡ŒGO/KEGGå¯Œé›†åˆ†æ
5. **è½¨è¿¹åˆ†æ**: å¦‚æœæ˜¯å‘è‚²æ•°æ®ï¼Œå¯ä»¥è¿›è¡Œæ‹Ÿæ—¶åºåˆ†æ
6. **æ•´åˆåˆ†æ**: ä¸å…¶ä»–æ•°æ®é›†æ•´åˆ

## æ¨èèµ„æº

- [Seuratå®˜æ–¹æ•™ç¨‹](https://satijalab.org/seurat/articles/get_started.html)
- [å•ç»†èƒåˆ†ææœ€ä½³å®è·µ](https://www.sc-best-practices.org/)
- ç»§ç»­å­¦ä¹ æœ¬åŒ…çš„å…¶ä»–æ•™ç¨‹

# ğŸ’¡ å°è´´å£«

1. **ä¿å­˜æ£€æŸ¥ç‚¹**: åœ¨é‡è¦æ­¥éª¤åä¿å­˜å¯¹è±¡
2. **ç‰ˆæœ¬å…¼å®¹**: ç¡®ä¿Seuratç‰ˆæœ¬å…¼å®¹ï¼ˆæ¨èv4.0+ï¼‰
3. **å†…å­˜ç®¡ç†**: å¤§æ•°æ®é›†å¤„ç†æ—¶æ³¨æ„å†…å­˜ä½¿ç”¨
4. **å‚æ•°è°ƒä¼˜**: æ ¹æ®æ•°æ®ç‰¹ç‚¹è°ƒæ•´èšç±»åˆ†è¾¨ç‡ç­‰å‚æ•°

---

**éœ€è¦å¸®åŠ©ï¼Ÿ**
- æŸ¥çœ‹å‡½æ•°å¸®åŠ©: `?read1Cellbio`, `?as.Seurat`
- Seuratå¸®åŠ©: `vignette("seurat")`
- é¡¹ç›®Issues: [GitHubåœ°å€]